!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=337)}({0:function(e,t){e.exports=require("util")},1:function(e,t){e.exports=require("path")},19:function(e,t){e.exports=require("child_process")},20:function(e,t){e.exports=require("http")},21:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(19),o=n(3),s=n(1),i=n(0);async function c(e,t,n){const{stdout:o}=await async function(e,t,n,o){const s=await a("docker",e,t);return i.promisify(r.execFile)(s,["exec",n,...o],{cwd:e,env:t}).catch(e=>e)}(e,t,n,["/bin/sh","-c",'for pid in `cd /proc && ls -d [0-9]*`; do { echo $pid ; readlink -f /proc/$pid/cwd ; xargs -0 < /proc/$pid/cmdline ; } | tr "\n" " " ; echo ; done 2>/dev/null']);return o.split("\n").map(e=>e.split(" ")).filter(e=>e.length>=3).map(e=>[...e.slice(0,2),e.slice(2).join(" ")]).map(e=>({pid:e[0],cwd:e[1],cmd:e[2]}))}async function a(e,t,n){if("win32"!==process.platform)return e;if(s.isAbsolute(e))return e;if("."!==s.dirname(e))return s.join(t,e);let r=void 0;if(n)for(let e of Object.keys(n))if("path"===e.toLowerCase()){const t=n[e];"string"==typeof t&&(r=t.split(s.delimiter));break}if(void 0===r||0===r.length)return s.join(t,e);for(let n of r){let r;if(r=s.isAbsolute(n)?s.join(n,e):s.join(t,n,e),await u(r))return r;let o=r+".com";if(await u(o))return o;if(o=r+".exe",await u(o))return o}return s.join(t,e)}function u(e){return new Promise(t=>o.exists(e,t))}t.findExtensionHostProcesses=async function(e,t,n){return(await c(e,t,n)).filter(e=>-1!==e.cmd.indexOf("--type=extensionHost"))},t.findProcesses=c,t.runCommandNoPty=async function(e,t,n,o,s={}){s.silent||o.write(`Run: ${t} ${n.join(" ")}\r\n`);const i={...process.env,...s.env||{}};return t=await a(t,e,i),new Promise((o,c)=>{const a=[],u=[],d=r.spawn(t,n,{cwd:e,env:i});d.stdout.on("data",e=>{a.push(e)}),d.stderr.on("data",e=>{u.push(e)}),d.on("exit",e=>{try{e?c({message:`Command failed: ${t} ${n.join(" ")}`,stdout:Buffer.concat(a),stderr:Buffer.concat(u),code:e}):o({stdout:Buffer.concat(a),stderr:Buffer.concat(u)})}catch(e){c(e)}}),s.stdin&&d.stdin.write(s.stdin,e=>{e?c(e):d.stdin.end()})})},t.findWindowsExecutable=a,t.tsnode=s.join(__dirname,"..","..","..","node_modules",".bin","ts-node");const d="ts-node"===s.basename(process.argv[0])||-1!==process.argv.indexOf("ts-node/register");t.fork=d?(e,n,o)=>r.spawn(t.tsnode,[e,...n||[]],o):r.fork},28:function(e,t){e.exports=require("crypto")},3:function(e,t){e.exports=require("fs")},337:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(60),o=n(3),s=n(1),i=n(7),c=n(338),a=n(339),u=n(21),d=process.argv[2],f=process.argv[3];let p="trace"===process.argv[4];const l=s.join(__dirname,"shutdownMonitor.log");function m(e){p&&(o.appendFileSync(l,`[${(new Date).toISOString()}] ${e}${i.EOL}`),r.sendData(d,JSON.stringify({type:"trace",message:e})).catch(()=>{}))}m("Starting monitor process...");const g=Date.now();let w;async function y(e){if(m(`Cleaning up after ${Date.now()-g}ms...`),w)switch(f){case"dockerCompose":await c.dockerComposeShutdown(w,m);break;case"singleContainer":await a.singleContainerShutdown(w,m);break;case"test":const{stdout:e,stderr:t}=await u.runCommandNoPty(process.cwd(),w.cmd,w.args,{write(e){m(e)}},{env:w.env});m("Command output: "+JSON.stringify({stdout:e.toString(),stderr:t.toString()}));break;default:m(`Type does not exist: ${f}`)}else m("Not configured!");if(m("Done."),e)try{const e=await r.sendData(d,JSON.stringify({type:"done"})),t=await r.readJSON(e);m("Received reply: "+JSON.stringify(t))}catch(e){m("Error confirming to extension: "+(e&&(e.stack||e.message)||String(e)))}}(async()=>{for(;;)try{const e=await r.sendData(d,JSON.stringify({type:"poll"})),t=await r.readJSON(e);m("Received message: "+JSON.stringify(t));for(const e of t){if("cleanup"===e.type)return void await y(!0);"configure"===e.type&&(w=e.options,r.sendData(d,JSON.stringify({type:"reply",sequence:e.sequence})).catch(e=>{m("Error confirming configuration: "+(e&&(e.stack||e.message)||String(e)))}))}}catch(e){if(m("Error polling extension: "+(e&&(e.stack||e.message)||String(e))),e&&"ECONNREFUSED"===e.code)return void await y(!1)}})().catch(e=>{m("Unexpected error: "+(e&&(e.stack||e.message)||String(e)))})},338:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(21);t.dockerComposeShutdown=async function(e,t){if(e.rebuild){const n=["rm","-f",e.containerId],{stdout:o,stderr:s}=await r.runCommandNoPty(process.cwd(),"docker",n,{write(e){t(e)}},{env:e.env});t("Command output: "+JSON.stringify({stdout:o.toString(),stderr:s.toString()}))}else if((!e.shutdownAction||"stopCompose"===e.shutdownAction)&&(await r.findExtensionHostProcesses(e.cwd,e.env,e.containerId)).length<=1){const n=["--project-name",e.projectName];e.composeFiles.forEach(e=>n.push("-f",e)),n.push("stop","-t","0"),e.runServices&&e.runServices.length&&n.push(...e.runServices);const{stdout:o,stderr:s}=await r.runCommandNoPty(process.cwd(),"docker-compose",n,{write(e){t(e)}},{env:e.env});t("Command output: "+JSON.stringify({stdout:o.toString(),stderr:s.toString()}))}}},339:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(21);t.singleContainerShutdown=async function(e,t){if(e.rebuild){const n=["rm","-f",e.containerId],{stdout:o,stderr:s}=await r.runCommandNoPty(process.cwd(),"docker",n,{write(e){t(e)}},{env:e.env});t("Command output: "+JSON.stringify({stdout:o.toString(),stderr:s.toString()}))}else if((!e.shutdownAction||"stopContainer"===e.shutdownAction)&&(await r.findExtensionHostProcesses(e.cwd,e.env,e.containerId)).length<=e.extensionHostsIfLast){const n=["stop","-t","0",e.containerId],{stdout:o,stderr:s}=await r.runCommandNoPty(process.cwd(),"docker",n,{write(e){t(e)}},{env:e.env});t("Command output: "+JSON.stringify({stdout:o.toString(),stderr:s.toString()}))}}},60:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1),o=n(20),s=n(7),i=n(28);t.createServer=async function(e,t){const n=(a=`${e}-${(await async function(e){return new Promise((t,n)=>{i.randomBytes(e,(e,r)=>{e?n(e):t(r)})})}(20)).toString("hex")}`,"win32"===process.platform?`\\\\.\\pipe\\${a}-sock`:process.env.XDG_RUNTIME_DIR?r.join(process.env.XDG_RUNTIME_DIR,`${a}.sock`):r.join(s.tmpdir(),`${a}.sock`)),o=new c(n,t);var a;return o.listen(),o};class c{constructor(e,t){this.ipcHandlePath=e,this.server=o.createServer((e,n)=>{Promise.resolve(t(e,n)).catch(e=>console.error(e&&e.message||e))}),this.server.on("error",e=>console.error(e))}listen(){this.server.listen(this.ipcHandlePath)}dispose(){this.server.close()}}t.Server=c,t.readJSON=async function(e){return new Promise((t,n)=>{const r=[];e.setEncoding("utf8"),e.on("data",e=>r.push(e)),e.on("error",e=>n(e)),e.on("end",()=>{const e=JSON.parse(r.join(""));t(e)})})},t.sendData=async function(e,t){return new Promise((n,r)=>{const s={socketPath:e,path:"/",method:"POST"},i=o.request(s,e=>n(e));i.on("error",e=>r(e)),i.write(t),i.end()})};t.Queue=class{constructor(){this.messages=[]}push(e){this.messages.push(e),this.dequeueRequest&&(this.dequeueRequest.resolve(this.messages),this.dequeueRequest=void 0,this.messages=[])}async dequeue(e){if(this.messages.length){const e=this.messages;return this.messages=[],e}return this.dequeueRequest&&this.dequeueRequest.resolve([]),new Promise((t,n)=>{this.dequeueRequest={resolve:t,reject:n},"number"==typeof e&&setTimeout(n,e)})}}},7:function(e,t){e.exports=require("os")}}));
//# sourceMappingURL=shutdownMonitorProcess.js.map